import { useMemo, useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { motion } from "framer-motion";

// --- Inline SVG Icons ---
function IconWand(props) {
  return (
    <svg viewBox="0 0 24 24" width="16" height="16" {...props}>
      <path fill="currentColor" d="M3.53 20.47a1.5 1.5 0 0 1 0-2.12l8.6-8.6a1.5 1.5 0 0 1 2.12 0l.94.94a1.5 1.5 0 0 1 0 2.12l-8.6 8.6a1.5 1.5 0 0 1-2.12 0l-.94-.94Z"/>
    </svg>
  );
}

function IconImage(props) {
  return (
    <svg viewBox="0 0 24 24" width="16" height="16" {...props}>
      <path fill="currentColor" d="M5 5a3 3 0 0 0-3 3v8a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V8a3 3 0 0 0-3-3H5Z"/>
    </svg>
  );
}

// --- Image Assets ---
// Embed the before image directly as default
const YELLOW_HOUSE = "sandbox:/mnt/data/IMG_4498.png";

// --- Constants & Helpers ---
const PRESET_MODERN_FULL = "Imagine Modern white exterior, black trim, and walkway";
const DEFAULT_PROMPTS = [
  PRESET_MODERN_FULL,
  "Add Stone Walkway",
  "Modern Black Windows",
  "Imagine White Vinyl Siding",
  "Wrap-around Porch",
  "Brick Exterior",
];

function validatePrompt(p) {
  return typeof p === "string" && p.trim().length > 0;
}

function styleFromPrompts(features) {
  const map = {
    "Imagine White Vinyl Siding": "grayscale(0.1) brightness(1.1)",
    "Add Stone Walkway": "contrast(1.05) saturate(1.03)",
    "Modern Black Windows": "contrast(1.05) brightness(1.05)",
    "Wrap-around Porch": "sepia(0.1) saturate(1.03)",
    "Brick Exterior": "saturate(1.15) hue-rotate(-5deg)",
  };
  return features.map((f) => map[f] ?? "none").join(" ");
}

function normalizeFeatureName(name) {
  const n = name.trim().toLowerCase();
  if (n === "black modern windows") return "Modern Black Windows";
  return name.trim();
}

function estimateDeltaForFeature(promptName, basePrice) {
  if (promptName === PRESET_MODERN_FULL) return 150000;
  const fixed = {
    "Add Stone Walkway": 8000,
    "Imagine White Vinyl Siding": 4500,
  };
  const pct = {
    "Modern Black Windows": 0.02,
    "Wrap-around Porch": 0.04,
    "Brick Exterior": 0.03,
  };
  if (fixed[promptName] != null) return fixed[promptName];
  if (pct[promptName] != null) return Math.round(basePrice * pct[promptName]);
  return 3000;
}

function computeEstimate(basePrice, features) {
  const uplift = features.reduce((sum, f) => sum + (f.delta || 0), 0);
  return { uplift, estimate: basePrice + uplift };
}

function formatUSD(n) {
  try {
    return n.toLocaleString(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
  } catch {
    return `$${Math.round(n)}`;
  }
}

export default function HouseVisualizer() {
  const [imageUrl] = useState(YELLOW_HOUSE);
  const [basePrice] = useState(500000);
  const [appliedFeatures, setAppliedFeatures] = useState([]);
  const [customPrompt, setCustomPrompt] = useState("");

  const prompts = useMemo(() => DEFAULT_PROMPTS, []);
  const filterStyle = useMemo(
    () => ({ filter: styleFromPrompts(appliedFeatures.map((f) => f.name)) }),
    [appliedFeatures]
  );
  const valuation = useMemo(() => computeEstimate(basePrice, appliedFeatures), [basePrice, appliedFeatures]);

  const applyFeature = (rawName) => {
    if (!validatePrompt(rawName)) return;
    const name = normalizeFeatureName(rawName);
    setAppliedFeatures((prev) => {
      if (prev.some((f) => f.name === name)) return prev;
      const delta = estimateDeltaForFeature(name, basePrice);
      return [...prev, { name, delta }];
    });
  };

  const removeFeature = (name) => setAppliedFeatures((prev) => prev.filter((f) => f.name !== name));
  const clearAll = () => setAppliedFeatures([]);

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="flex flex-col items-center">
          <Card className="w-full shadow-lg">
            <CardContent className="p-4">
              <div className="relative">
                <img
                  src={imageUrl}
                  alt="House preview"
                  className="rounded-2xl shadow-md w-full h-auto"
                  style={filterStyle}
                />
              </div>
            </CardContent>
          </Card>

          <div className="w-full mt-4">
            <h2 className="text-base font-semibold mb-2">Preset Designs</h2>
            <div className="flex flex-wrap gap-2">
              {prompts.map((prompt) => (
                <Button key={prompt} size="sm" variant="outline" onClick={() => applyFeature(prompt)}>
                  <IconWand className="mr-2" /> {prompt}
                </Button>
              ))}
            </div>

            <div className="mt-3">
              {appliedFeatures.length > 0 ? (
                <div className="flex flex-wrap gap-2">
                  {appliedFeatures.map((f) => (
                    <span key={f.name} className="px-3 py-1 rounded-full bg-gray-200 text-gray-800 text-sm flex items-center gap-2">
                      {f.name}
                      <button aria-label={`Remove ${f.name}`} onClick={() => removeFeature(f.name)} className="text-gray-600 hover:text-gray-900">×</button>
                    </span>
                  ))}
                  <Button size="sm" variant="ghost" onClick={clearAll}>Clear all</Button>
                </div>
              ) : (
                <p className="text-xs text-gray-500">Added features will appear here as pills.</p>
              )}
            </div>
          </div>
        </motion.div>

        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="flex flex-col space-y-6">
          <h1 className="text-2xl font-bold">Visualize Your Dream Home</h1>
          <p className="text-gray-600">Select design presets below the photo. You can stack multiple features—e.g., walkway + modern black windows.</p>

          <div className="pt-4 border-t border-gray-200">
            <h2 className="text-lg font-semibold mb-2">Custom Request</h2>
            <div className="flex space-x-2">
              <Input
                placeholder="e.g., Add a two-car garage with dormers"
                value={customPrompt}
                onChange={(e) => setCustomPrompt(e.target.value)}
              />
              <Button variant="secondary" onClick={() => applyFeature(customPrompt)} disabled={!validatePrompt(customPrompt)}>
                <IconImage className="mr-2" /> Submit
              </Button>
            </div>
          </div>

          <Card className="mt-2">
            <CardContent className="p-4">
              <h3 className="text-lg font-semibold mb-3">Estimated Value</h3>
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div className="text-gray-600">Base</div>
                <div className="text-right font-medium">{formatUSD(basePrice)}</div>
                <div className="text-gray-600">Feature Uplift</div>
                <div className="text-right font-medium">{formatUSD(valuation.uplift)}</div>
                <div className="col-span-2 border-t pt-2"></div>
                <div className="text-gray-900 font-semibold">New Estimate</div>
                <div className="text-right text-xl font-bold">{formatUSD(valuation.estimate)}</div>
              </div>

              <div className="mt-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium">Applied Features</span>
                  <button className="text-xs text-blue-600 hover:underline" onClick={clearAll}>Clear all</button>
                </div>
                {appliedFeatures.length === 0 ? (
                  <p className="text-xs text-gray-500">No features added yet.</p>
                ) : (
                  <ul className="space-y-1">
                    {appliedFeatures.map((f) => (
                      <li key={f.name} className="flex items-center justify-between text-sm">
                        <span>{f.name}</span>
                        <span className="flex items-center gap-3">
                          <span className="font-medium">{formatUSD(f.delta)}</span>
                          <button className="px-2 py-0.5 text-xs rounded bg-gray-100 hover:bg-gray-200" onClick={() => removeFeature(f.name)}>×</button>
                        </span>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </CardContent>
          </Card>
        </motion.div>
      </div>
    </div>
  );
}

function runSmokeTests() {
  try {
    console.assert(styleFromPrompts(["Add Stone Walkway"]).includes("contrast"), "Stone walkway style");
    console.assert(styleFromPrompts(["Modern Black Windows"]).includes("contrast"), "Windows style");
    const base = 500000;
    const walkway = { name: "Add Stone Walkway", delta: estimateDeltaForFeature("Add Stone Walkway", base) };
    const windows = { name: "Modern Black Windows", delta: estimateDeltaForFeature("Modern Black Windows", base) };
    const combo = computeEstimate(base, [walkway, windows]);
    console.assert(combo.estimate === base + walkway.delta + windows.delta, "Stacked features should sum");

    const modernPreset = { name: PRESET_MODERN_FULL, delta: estimateDeltaForFeature(PRESET_MODERN_FULL, base) };
    console.assert(modernPreset.delta === 150000, "Modern white preset should add $150,000");
    const modernEstimate = computeEstimate(base, [modernPreset]);
    console.assert(modernEstimate.estimate === 650000, "Estimate should be $650,000 with modern preset");

    console.assert(typeof YELLOW_HOUSE === "string" && /IMG_4498\.png$/.test(YELLOW_HOUSE), "YELLOW_HOUSE should be IMG_4498.png");
    console.log("✅ Tests passed");
  } catch (err) {
    console.error("❌ Tests failed", err);
  }
}

if (typeof window !== "undefined") setTimeout(runSmokeTests, 50);
